{% extends "base.html" %}

{% block title %}Tableau de Bord - Kanban{% endblock %}

{% block extra_head %}
<style>
  /* Modal Styles */
  .modal {
    display: none;
    position: fixed;
    z-index: 200;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0, 0, 0, 0.4);
  }

  .modal-content {
    background-color: #fefefe;
    margin: 15% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 80%;
    max-width: 500px;
    border-radius: 8px;
  }

  .close {
    color: #aaa;
    cursor: pointer;
    float: right;
    font-size: 28px;
    font-weight: bold;
  }

  .close:hover,
  .close:focus {
    color: black;
    text-decoration: none;
    cursor: pointer;
  }
</style>
{% endblock %}

{% block content %}
<header class="header-actions"
  style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
  <h1 style="margin: 0;">Tableau de Bord</h1>
  <div style="display: flex; gap: 10px;">
    <a href="{{ url_for('export_db') }}" class="btn-primary"
      style="text-decoration: none; padding: 8px 16px; font-size: 14px; background-color: #10b981;">Export CSV</a>

    <form action="{{ url_for('import_db') }}" method="POST" enctype="multipart/form-data" style="display: inline;">
      <input type="file" name="file" id="importFile" accept=".csv" style="display: none;" onchange="this.form.submit()">
      <button type="button" onclick="document.getElementById('importFile').click()" class="btn-primary"
        style="padding: 8px 16px; font-size: 14px; background-color: #f59e0b;">Import CSV</button>
    </form>

    <button onclick="openManualModal()" class="btn-primary"
      style="font-size: 24px; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; padding: 0; line-height: 1;">+</button>
  </div>
</header>

<div class="kanban-board">
  {% set statuses = [
  ('En pr√©paration', 'col-en-preparation'),
  ('Envoy√©e', 'col-envoyee'),
  ('Entretien', 'col-entretien'),
  ('Offre', 'col-offre'),
  ('Refus', 'col-refus')
  ] %}

  {% for status, col_class in statuses %}
  <div class="kanban-column {{ col_class }}">
    <h3>
      {{ status }}
      <span class="count" id="count-{{ status | replace(' ', '-') }}">{{ candidatures | selectattr("statut", "equalto",
        status) | list | length }}</span>
    </h3>
    <div class="kanban-cards" id="list-{{ status | replace(' ', '-') }}" data-status="{{ status }}">
      {% for cand in candidatures if cand.statut == status %}
      <div class="kanban-card" data-id="{{ cand.id }}">
        <div class="card-header">
          <span class="card-company">
            {{ cand.entreprise }}
            {% if cand.url_offer %}
            <a href="{{ cand.url_offer }}" target="_blank" title="Voir l'offre" style="text-decoration: none;">üîó</a>
            {% endif %}
          </span>
          <span class="card-date">{{ cand.date_creation.strftime('%d/%m') }}</span>
        </div>
        <div class="card-role">{{ cand.poste }}</div>
        <div class="card-actions">
          {% if cand.fichier_pdf %}
          <a href="{{ url_for('download', filename=cand.fichier_pdf) }}" class="card-action-btn"
            title="T√©l√©charger PDF">üìÑ</a>
          {% endif %}
          <button onclick="openEmailModal('{{ cand.id }}', '{{ cand.entreprise }}', '{{ cand.poste }}')"
            class="card-action-btn" title="Email">‚úâÔ∏è</button>
          <button onclick="openLinkedinModal('{{ cand.id }}', '{{ cand.entreprise }}', '{{ cand.poste }}')"
            class="card-action-btn" title="LinkedIn">üëî</button>
          <a href="{{ url_for('delete_candidature', id=cand.id) }}" onclick="return confirm('Supprimer ?');"
            class="card-action-btn delete" title="Supprimer">üóëÔ∏è</a>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endfor %}
</div>

<!-- Email Modal -->
<div id="emailModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeEmailModal()">&times;</span>
    <h2>Pr√©parer un email</h2>
    <p id="modal-subtitle" class="text-muted"></p>

    <form id="emailForm" method="POST" enctype="multipart/form-data">
      <div class="form-group">
        <label for="email_destinataire">Email du destinataire :</label>
        <input type="email" id="email_destinataire" name="email_destinataire" required
          placeholder="recruteur@entreprise.com">
      </div>

      <div class="form-group">
        <label for="cv_file">Joindre un CV (PDF) :</label>
        <input type="file" id="cv_file" name="cv_file" accept=".pdf" required>
        <small class="text-muted">La lettre de motivation g√©n√©r√©e sera automatiquement jointe.</small>
      </div>

      <div style="text-align: right; margin-top: 20px;">
        <button type="submit" class="btn-primary">G√©n√©rer le brouillon</button>
      </div>
    </form>
  </div>
</div>


<!-- Manual Entry Modal -->
<div id="manualModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeManualModal()">&times;</span>
    <h2>Ajouter une candidature</h2>
    <form action="{{ url_for('add_manual') }}" method="POST" enctype="multipart/form-data">
      <div class="form-group">
        <label for="entreprise">Entreprise *</label>
        <input type="text" id="entreprise" name="entreprise" required>
      </div>
      <div class="form-group">
        <label for="poste">Poste / Offre *</label>
        <input type="text" id="poste" name="poste" required>
      </div>
      <div class="form-group">
        <label for="date">Date</label>
        <input type="date" id="date" name="date" value="{{ now_date }}">
      </div>
      <div class="form-group">
        <label for="url_offer">Lien de l'annonce</label>
        <input type="url" id="url_offer" name="url_offer" placeholder="https://...">
      </div>
      <div class="form-group">
        <label for="notes">Notes</label>
        <textarea id="notes" name="notes" rows="3"></textarea>
      </div>
      <div class="form-group">
        <label for="pdf_file">Fichier (CV/Lettre)</label>
        <input type="file" id="pdf_file" name="pdf_file" accept=".pdf">
      </div>
      <div style="text-align: right; margin-top: 20px;">
        <button type="submit" class="btn-primary">Ajouter</button>
      </div>
    </form>
  </div>
</div>

<!-- LinkedIn Modal -->
<div id="linkedinModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeLinkedinModal()">&times;</span>
    <h2>Message LinkedIn</h2>
    <p id="linkedin-subtitle" class="text-muted"></p>

    <div id="linkedin-loading" style="display: none; text-align: center; padding: 20px;">
      <p>G√©n√©ration en cours avec Gemini...</p>
    </div>

    <div id="linkedin-result" style="display: none;">
      <div class="form-group">
        <label for="linkedin-subject">Objet :</label>
        <input type="text" id="linkedin-subject" readonly style="width: 100%; padding: 8px; margin-bottom: 10px;">
      </div>
      <div class="form-group">
        <label for="linkedin-body">Message :</label>
        <textarea id="linkedin-body" rows="6" style="width: 100%; padding: 8px;"></textarea>
        <small id="char-count" class="text-muted" style="float: right;">0 caract√®res</small>
      </div>

      <div style="text-align: right; margin-top: 20px;">
        <button onclick="copyLinkedinText()" class="btn-primary" style="background-color: #2563eb;">Copier</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // Initialize SortableJS
  document.addEventListener('DOMContentLoaded', function () {
    const columns = document.querySelectorAll('.kanban-cards');
    columns.forEach(column => {
      new Sortable(column, {
        group: 'kanban', // Allow dragging between lists
        animation: 150,
        ghostClass: 'sortable-ghost',
        onEnd: function (evt) {
          const itemEl = evt.item;
          const newStatus = evt.to.getAttribute('data-status');
          const candidatureId = itemEl.getAttribute('data-id');

          // Update backend
          fetch(`/api/update_status/${candidatureId}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ statut: newStatus }),
          })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                // Update counts (optional, but good for UX)
                updateCounts();
              } else {
                alert('Erreur lors de la mise √† jour du statut');
                // Revert move (reload page is simplest fallback)
                location.reload();
              }
            })
            .catch((error) => {
              console.error('Error:', error);
              alert('Erreur de connexion');
            });
        }
      });
    });
  });

  function updateCounts() {
    // Simple recount based on DOM
    document.querySelectorAll('.kanban-column').forEach(col => {
      const status = col.querySelector('.kanban-cards').getAttribute('data-status');
      const count = col.querySelectorAll('.kanban-card').length;
      const countBadge = col.querySelector('.count');
      if (countBadge) countBadge.textContent = count;
    });
  }

  // Modal Logic
  function openEmailModal(id, entreprise, poste) {
    var modal = document.getElementById("emailModal");
    var form = document.getElementById("emailForm");
    var subtitle = document.getElementById("modal-subtitle");
    form.action = "/create_draft/" + id;
    subtitle.textContent = "Pour : " + poste + " chez " + entreprise;
    modal.style.display = "block";
  }

  function closeEmailModal() {
    document.getElementById("emailModal").style.display = "none";
  }

  window.onclick = function (event) {
    var emailModal = document.getElementById("emailModal");
    var manualModal = document.getElementById("manualModal");
    var linkedinModal = document.getElementById("linkedinModal");
    if (event.target == emailModal) {
      emailModal.style.display = "none";
    }
    if (event.target == manualModal) {
      manualModal.style.display = "none";
    }
    if (event.target == linkedinModal) {
      linkedinModal.style.display = "none";
    }
  }

  // Manual Modal Logic
  function openManualModal() {
    document.getElementById("manualModal").style.display = "block";
    // Set default date to today if empty (handled by backend but good for UI)
    if (!document.getElementById("date").value) {
      document.getElementById("date").valueAsDate = new Date();
    }
  }

  function closeManualModal() {
    document.getElementById("manualModal").style.display = "none";
  }

  // LinkedIn Modal Logic
  function openLinkedinModal(id, entreprise, poste) {
    var modal = document.getElementById("linkedinModal");
    var subtitle = document.getElementById("linkedin-subtitle");
    var loading = document.getElementById("linkedin-loading");
    var result = document.getElementById("linkedin-result");

    subtitle.textContent = "Pour : " + poste + " chez " + entreprise;
    modal.style.display = "block";
    loading.style.display = "block";
    result.style.display = "none";

    // Call API
    fetch('/generate_linkedin/' + id, { method: 'POST' })
      .then(response => response.json())
      .then(data => {
        loading.style.display = "none";
        result.style.display = "block";
        document.getElementById("linkedin-subject").value = data.objet;
        document.getElementById("linkedin-body").value = data.corps;
        updateCharCount();
      })
      .catch(err => {
        loading.style.display = "none";
        alert("Erreur lors de la g√©n√©ration : " + err);
      });
  }

  function closeLinkedinModal() {
    document.getElementById("linkedinModal").style.display = "none";
  }

  function updateCharCount() {
    var text = document.getElementById("linkedin-body").value;
    document.getElementById("char-count").textContent = text.length + " caract√®res";
  }

  document.getElementById("linkedin-body").addEventListener("input", updateCharCount);

  function copyLinkedinText() {
    var subject = document.getElementById("linkedin-subject").value;
    var body = document.getElementById("linkedin-body").value;
    var fullText = "Objet: " + subject + "\n\n" + body;

    navigator.clipboard.writeText(fullText).then(function () {
      alert("Copi√© dans le presse-papier !");
    }, function (err) {
      console.error('Async: Could not copy text: ', err);
    });
  }
</script>
{% endblock %}